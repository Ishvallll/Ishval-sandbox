<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Meteor System FINAL</title>

<style>
    body {
        margin: 0;
        overflow: hidden;
        background-color: #0444BC;
        touch-action: none;
    }

    .meteor {
        position: absolute;
        width: 192px;
        height: 192px;
        pointer-events: none;
        transform: translate(-50%, -50%);
    }

    .boom {
        position: absolute;
        width: 1280px;
        height: 1280px;
        pointer-events: none;
        transform: translate(-50%, -50%);
    }

    @keyframes shake {
        0%   { transform: translate(0,0); }
        20%  { transform: translate(35px,-35px); }
        40%  { transform: translate(-35px,35px); }
        60%  { transform: translate(40px,40px); }
        80%  { transform: translate(-40px,-40px); }
        100% { transform: translate(0,0); }
    }

    .shake {
        animation: shake 0.3s;
    }
</style>
</head>

<body>

<script>
let dragging = false;
let lastSpawn = 0;
const spamDelay = 10; // 0.01s
let lastInputType = null;

/* ===== AUDIO PROFISSIONAL ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let boomBuffer = null;

fetch("brick1.ogg")
    .then(r => r.arrayBuffer())
    .then(b => audioCtx.decodeAudioData(b))
    .then(buf => boomBuffer = buf);

function playBoomSound() {
    if (!boomBuffer) return;

    const src = audioCtx.createBufferSource();
    src.buffer = boomBuffer;

    // pitch REAL (cents)
    src.detune.value = (Math.random() * 800) - 400;

    src.connect(audioCtx.destination);
    src.start();
}

/* ===== METEORO ===== */
function spawnMeteor(targetX, targetY) {
    const now = performance.now();
    if (now - lastSpawn < spamDelay) return;
    lastSpawn = now;

    const meteor = document.createElement("img");
    meteor.src = "meteor.gif";
    meteor.className = "meteor";

    const startX = Math.random() * window.innerWidth;
    const startY = -200;

    meteor.style.left = startX + "px";
    meteor.style.top = startY + "px";

    document.body.appendChild(meteor);

    const duration = 400;
    const startTime = performance.now();

    function animate(t) {
        const p = Math.min((t - startTime) / duration, 1);

        meteor.style.left = (startX + (targetX - startX) * p) + "px";
        meteor.style.top  = (startY + (targetY - startY) * p) + "px";

        if (p < 1) {
            requestAnimationFrame(animate);
        } else {
            meteor.remove();
            spawnBoom(targetX, targetY);
        }
    }

    requestAnimationFrame(animate);
}

/* ===== BOOM ===== */
function spawnBoom(x, y) {
    const boom = document.createElement("img");
    boom.src = "boom.gif?" + Math.random(); // força play único
    boom.className = "boom";

    boom.style.left = x + "px";
    boom.style.top = y + "px";

    // camada baseada na altura
    boom.style.zIndex = Math.floor(y);

    document.body.appendChild(boom);

    playBoomSound();

    document.body.classList.remove("shake");
    void document.body.offsetWidth;
    document.body.classList.add("shake");

    setTimeout(() => boom.remove(), 1580);
}

/* ===== INPUT ===== */
function handleInput(x, y, type) {
    if (lastInputType && lastInputType !== type) return;
    lastInputType = type;
    spawnMeteor(x, y);
}

/* Mouse */
document.addEventListener("mousedown", e => {
    dragging = true;
    handleInput(e.clientX, e.clientY, "mouse");
});

document.addEventListener("mousemove", e => {
    if (dragging) handleInput(e.clientX, e.clientY, "mouse");
});

document.addEventListener("mouseup", () => {
    dragging = false;
    lastInputType = null;
});

/* Touch */
document.addEventListener("touchstart", e => {
    audioCtx.resume();
    dragging = true;
    const t = e.touches[0];
    handleInput(t.clientX, t.clientY, "touch");
});

document.addEventListener("touchmove", e => {
    if (!dragging) return;
    const t = e.touches[0];
    handleInput(t.clientX, t.clientY, "touch");
});

document.addEventListener("touchend", () => {
    dragging = false;
    lastInputType = null;
});
</script>

</body>
</html>
